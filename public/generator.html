<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tele Tech AI (Chat)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f9;
}
.container {
  max-width: 600px;
  margin: 30px auto;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,.1);
  padding: 15px;
  display: flex;
  flex-direction: column;
  height: 85vh;
}
h2 {
  text-align: center;
  margin-bottom: 10px;
}
#chat {
  flex: 1;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 6px;
  background: #fafafa;
}
.msg {
  display: flex;
  gap: 6px;
  margin-bottom: 8px;
}
.user { justify-content: flex-end; }
.ai { justify-content: flex-start; }
.bubble {
  padding: 8px 12px;
  border-radius: 14px;
  max-width: 75%;
  word-wrap: break-word;
}
.user .bubble {
  background:#007bff;
  color:#fff;
}
.ai .bubble {
  background:#e9e9e9;
  color:#000;
}
.delete {
  cursor:pointer;
  color:red;
  font-size:13px;
}
.input-box {
  display:flex;
  gap:6px;
  margin-top:10px;
}
textarea {
  flex:1;
  resize:none;
  height:50px;
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
}
button {
  background:#28a745;
  color:white;
  border:none;
  border-radius:6px;
  padding:0 16px;
  cursor:pointer;
}
.top-actions {
  display:flex;
  justify-content:space-between;
  margin-bottom:8px;
}
.clear {
  background:#dc3545;
  padding:4px 10px;
  font-size:12px;
}
</style>
</head>

<body>

<div class="container">
  <h2>Tele Tech AI (Text)</h2>

  <div class="top-actions">
    <button class="clear" onclick="clearChat()">Clear All</button>
    <small id="limitInfo"></small>
  </div>

  <div id="chat"></div>

  <div class="input-box">
    <textarea id="msg" placeholder="Type your message..."></textarea>
    <button onclick="sendMsg()">Send</button>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const FREE_LIMIT = 5;
const RESET_HOURS = 8;

/* ===== USER ===== */
const user = JSON.parse(localStorage.getItem("user") || "{}");
const plan = user.plan || "free";

/* ===== USAGE ===== */
let usage = JSON.parse(localStorage.getItem("usage") || "{}");
const now = Date.now();

if (!usage.start || (now - usage.start) > RESET_HOURS * 60 * 60 * 1000) {
  usage = { count: 0, start: now };
  localStorage.setItem("usage", JSON.stringify(usage));
}

/* ===== CHAT STORAGE ===== */
function loadChat() {
  const chat = document.getElementById("chat");
  const saved = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  chat.innerHTML = "";
  saved.forEach(m => renderMsg(m.role, m.text, false));
  chat.scrollTop = chat.scrollHeight;
}

function saveMsg(role, text) {
  const saved = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  saved.push({ role, text });
  localStorage.setItem("chatHistory", JSON.stringify(saved));
}

function deleteMsg(el) {
  const div = el.parentElement;
  const text = div.querySelector(".bubble").innerText;
  const role = div.classList.contains("user") ? "user" : "ai";
  let saved = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  saved = saved.filter(m => !(m.role === role && m.text === text));
  localStorage.setItem("chatHistory", JSON.stringify(saved));
  div.remove();
}

function clearChat() {
  if (!confirm("Delete all chats?")) return;
  localStorage.removeItem("chatHistory");
  document.getElementById("chat").innerHTML = "";
}

/* ===== UI ===== */
function renderMsg(role, text, save=true) {
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  div.className = `msg ${role}`;
  div.innerHTML = `
    <span class="delete" onclick="deleteMsg(this)">‚ùå</span>
    <div class="bubble">${text}</div>
  `;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  if (save) saveMsg(role, text);
}

/* ===== SEND ===== */
async function sendMsg() {
  const input = document.getElementById("msg");
  const message = input.value.trim();
  if (!message) return;

  if (plan === "free" && usage.count >= FREE_LIMIT) {
    alert("Free limit reached. Please upgrade to Pro üöÄ");
    return;
  }

  renderMsg("user", message);
  input.value = "";

  const thinking = "thinking-" + Date.now();
  renderMsg("ai", "Thinking...", false);
  const lastAI = document.querySelectorAll(".ai .bubble");
  const aiBubble = lastAI[lastAI.length - 1];

  try {
    const res = await fetch("/chat", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ message })
    });
    const data = await res.json();
    aiBubble.innerText = data.success ? data.reply : "Error ‚ùå";
    saveMsg("ai", aiBubble.innerText);
    usage.count++;
    localStorage.setItem("usage", JSON.stringify(usage));
  } catch {
    aiBubble.innerText = "Server error ‚ùå";
  }

  updateLimitInfo();
}

function updateLimitInfo() {
  const el = document.getElementById("limitInfo");
  if (plan === "free") {
    el.innerText = `Free: ${usage.count}/${FREE_LIMIT}`;
  } else {
    el.innerText = "Pro User üöÄ";
  }
}

/* ===== INIT ===== */
loadChat();
updateLimitInfo();
</script>

</body>
</html>
