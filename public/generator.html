<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tele Tech AI (Chat)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f9;
}
.container {
  max-width: 600px;
  margin: 40px auto;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,.1);
  padding: 20px;
  display: flex;
  flex-direction: column;
  height: 80vh;
}
h2 { text-align: center; margin-bottom: 10px; }

#chat {
  flex: 1;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 6px;
  background: #fafafa;
}

.msg {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
}

.user { justify-content: flex-end; }
.ai { justify-content: flex-start; }

.bubble {
  padding: 6px 10px;
  border-radius: 12px;
  max-width: 80%;
  word-wrap: break-word;
}

.user .bubble {
  background: #007bff;
  color: #fff;
}
.ai .bubble {
  background: #e9e9e9;
  color: #000;
}

.delete {
  cursor: pointer;
  color: red;
  font-size: 14px;
}

.input-box {
  display: flex;
  gap: 6px;
  margin-top: 10px;
}

textarea {
  flex: 1;
  resize: none;
  height: 50px;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

button {
  padding: 0 16px;
  border: none;
  border-radius: 6px;
  background: #28a745;
  color: white;
  cursor: pointer;
}
</style>
</head>

<body>

<div class="container">
  <h2>Tele Tech AI (Text)</h2>

  <div id="chat"></div>

  <div class="input-box">
    <textarea id="msg" placeholder="Type your message..."></textarea>
    <button onclick="sendMsg()">Send</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const FREE_LIMIT = 5;
const RESET_HOURS = 8;

/* ================= USER ================= */
const user = JSON.parse(localStorage.getItem("user") || "{}");
const plan = user.plan || "free";

/* ================= USAGE ================= */
let usageData = JSON.parse(localStorage.getItem("usageData") || "{}");
const now = Date.now();

if (!usageData.startTime || (now - usageData.startTime) > RESET_HOURS * 60 * 60 * 1000) {
  usageData = { count: 0, startTime: now };
  localStorage.setItem("usageData", JSON.stringify(usageData));
}

/* ================= CHAT STORAGE ================= */
function loadChat() {
  const chat = document.getElementById("chat");
  const saved = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  chat.innerHTML = "";

  saved.forEach((m, i) => {
    chat.innerHTML += `
      <div class="msg ${m.role}">
        <span class="delete" onclick="deleteMsg(${i})">‚ùå</span>
        <div class="bubble">${m.text}</div>
      </div>
    `;
  });

  chat.scrollTop = chat.scrollHeight;
}

function saveMessage(role, text) {
  const saved = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  saved.push({ role, text });
  localStorage.setItem("chatHistory", JSON.stringify(saved));
}

function deleteMsg(index) {
  let saved = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  saved.splice(index, 1);
  localStorage.setItem("chatHistory", JSON.stringify(saved));
  loadChat();
}

/* ================= SEND MESSAGE ================= */
async function sendMsg() {
  const input = document.getElementById("msg");
  const message = input.value.trim();
  if (!message) return;

  if (plan === "free" && usageData.count >= FREE_LIMIT) {
    alert("Free limit reached. Please upgrade to Pro üöÄ");
    return;
  }

  saveMessage("user", message);
  input.value = "";
  loadChat();

  saveMessage("ai", "Thinking...");
  loadChat();

  try {
    const res = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message })
    });

    const data = await res.json();

    let saved = JSON.parse(localStorage.getItem("chatHistory"));
    saved[saved.length - 1].text =
      data.success ? data.reply : "Error ‚ùå";
    localStorage.setItem("chatHistory", JSON.stringify(saved));

    usageData.count++;
    localStorage.setItem("usageData", JSON.stringify(usageData));

    loadChat();

  } catch {
    let saved = JSON.parse(localStorage.getItem("chatHistory"));
    saved[saved.length - 1].text = "Server error ‚ùå";
    localStorage.setItem("chatHistory", JSON.stringify(saved));
    loadChat();
  }
}

/* ================= INIT ================= */
loadChat();
</script>

</body>
</html>
