<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tele Tech AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body style="font-family:Arial;background:#f4f6f9;margin:0;padding:10px;">

<h3 style="text-align:center;">Tele Tech AI</h3>

<div id="chat" style="
  height:60vh;
  overflow-y:auto;
  background:#fff;
  padding:10px;
  border:1px solid #ccc;
  border-radius:6px;
"></div>

<textarea id="msg"
  placeholder="Type your message..."
  style="width:100%;height:60px;margin-top:6px;"></textarea>

<button onclick="sendMsg()"
  style="width:100%;margin-top:6px;padding:10px;">
Send</button>

<p id="info" style="text-align:center;color:red;"></p>

<hr>

<input id="prompt"
  placeholder="Describe image (optional)"
  style="width:100%;margin-top:6px;">

<button onclick="generateImage()"
  style="width:100%;margin-top:6px;padding:10px;">
Generate Image</button>

<img id="img" style="max-width:100%;display:none;margin-top:10px;">

<script>
/* ===== FREE LIMIT ===== */
const FREE_LIMIT = 5;
const RESET_HOURS = 8;
const user = JSON.parse(localStorage.getItem("user")||"{}");
const plan = user.plan || "free";

let usage = JSON.parse(localStorage.getItem("usage")||"{}");
const now = Date.now();
if(!usage.start || now-usage.start > RESET_HOURS*3600000){
  usage={count:0,start:now};
}
localStorage.setItem("usage",JSON.stringify(usage));

/* ===== CHAT STORAGE ===== */
function loadChat(){
  const chat=document.getElementById("chat");
  const saved=JSON.parse(localStorage.getItem("chatHistory")||"[]");
  chat.innerHTML="";
  saved.forEach((m,i)=>{
    chat.innerHTML+=`
      <div>
        <b>${m.role}:</b> ${m.text}
        <span style="color:red;cursor:pointer;"
          onclick="deleteMsg(${i})"> ‚ùå</span>
      </div>`;
  });
}
loadChat();

function saveMsg(role,text){
  const saved=JSON.parse(localStorage.getItem("chatHistory")||"[]");
  saved.push({role,text});
  localStorage.setItem("chatHistory",JSON.stringify(saved));
}

function deleteMsg(i){
  const saved=JSON.parse(localStorage.getItem("chatHistory")||"[]");
  saved.splice(i,1);
  localStorage.setItem("chatHistory",JSON.stringify(saved));
  loadChat();
}

/* ===== SEND TEXT ===== */
async function sendMsg(){
  const msg=document.getElementById("msg");
  const info=document.getElementById("info");
  if(!msg.value.trim()) return;

  if(plan==="free" && usage.count>=FREE_LIMIT){
    info.innerText="Free limit reached. Upgrade to Pro üöÄ";
    return;
  }

  saveMsg("You",msg.value);
  loadChat();
  msg.value="";

  saveMsg("AI","Thinking...");
  loadChat();

  try{
    const res=await fetch("/chat",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({message:msg.value})
    });
    const data=await res.json();
    const saved=JSON.parse(localStorage.getItem("chatHistory"));
    saved[saved.length-1].text=data.success?data.reply:"Error";
    localStorage.setItem("chatHistory",JSON.stringify(saved));
  }catch{
    const saved=JSON.parse(localStorage.getItem("chatHistory"));
    saved[saved.length-1].text="Server error";
    localStorage.setItem("chatHistory",JSON.stringify(saved));
  }

  usage.count++;
  localStorage.setItem("usage",JSON.stringify(usage));
  loadChat();
}

/* ===== IMAGE ===== */
async function generateImage(){
  const p=document.getElementById("prompt").value.trim();
  if(!p) return;
  const img=document.getElementById("img");
  img.style.display="none";

  try{
    const res=await fetch("/generate",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({prompt:p})
    });
    const data=await res.json();
    if(data.success){
      img.src=data.image;
      img.style.display="block";
    }else{
      alert(data.message||"Failed");
    }
  }catch{
    alert("Server error");
  }
}
</script>

</body>
</html>
