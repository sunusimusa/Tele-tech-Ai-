<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tele Tech AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial; background:#f4f6f9; }
.box { max-width:600px; margin:20px auto; background:#fff; padding:10px; }
#chat { height:300px; border:1px solid #ccc; padding:8px; overflow-y:auto; }
.msg { margin-bottom:6px; }
.user { color:#007bff; }
.ai { color:#000; }
.del { color:red; cursor:pointer; margin-left:5px; }
</style>
</head>

<body>

<div class="box">
  <h3>Tele Tech AI</h3>

  <div id="chat"></div>

  <input id="msg" placeholder="Type message..." style="width:75%">
  <button id="sendBtn">Send</button>
</div>

<script>
// ===== LIMIT =====
const FREE_LIMIT = 10;

// ===== USER & USAGE =====
const user = JSON.parse(localStorage.getItem("user") || "{}");
const plan = user.plan || "free";

let usage = JSON.parse(localStorage.getItem("usage") || "{}");
const today = new Date().toDateString();

if (usage.date !== today) {
  usage = { count: 0, date: today };
  localStorage.setItem("usage", JSON.stringify(usage));
}

// ===== ELEMENTS =====
const chat = document.getElementById("chat");
const input = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");

// ===== LOAD OLD CHAT =====
const saved = JSON.parse(localStorage.getItem("chatData") || "[]");
saved.forEach(showMsg);

// ===== SEND =====
sendBtn.onclick = sendMsg;

async function sendMsg() {
  if (plan === "free" && usage.count >= FREE_LIMIT) {
    alert("Free limit reached (10/day). Upgrade to Pro üöÄ");
    return;
  }

  const text = input.value.trim();
  if (!text) return;

  addAndSave("You", text);
  input.value = "";

  try {
    const res = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text })
    });

    const data = await res.json();
    addAndSave("AI", data.reply || "Error");

    usage.count++;
    localStorage.setItem("usage", JSON.stringify(usage));

  } catch {
    addAndSave("AI", "Server error ‚ùå");
  }
}

// ===== HELPERS =====
function addAndSave(role, text) {
  showMsg({ role, text });

  const data = JSON.parse(localStorage.getItem("chatData") || "[]");
  data.push({ role, text });
  localStorage.setItem("chatData", JSON.stringify(data));
}

function showMsg(msg) {
  const div = document.createElement("div");
  div.className = "msg " + (msg.role === "You" ? "user" : "ai");
  div.innerHTML = `<b>${msg.role}:</b> ${msg.text}
    <span class="del" onclick="delMsg(this)">‚ùå</span>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function delMsg(el) {
  const div = el.parentElement;
  div.remove();
}
</script>

</body>
</html>
